#!/bin/bash

echo "========================================"
echo "   ğŸ” ç„¶å°äºŒ Â· æ‰‹åŠ¨è¯ä¹¦å®‰è£…å·¥å…·"
echo "========================================"

# 1. æ£€æŸ¥å¹¶å®‰è£… unzip
if [ -f /etc/debian_version ]; then
    if ! command -v unzip >/dev/null; then
        apt-get update -qq && apt-get install -y unzip nginx >/dev/null
    fi
    NGINX_USER="www-data"
elif [ -f /etc/redhat-release ]; then
    if ! command -v unzip >/dev/null; then
        yum install -y unzip nginx >/dev/null
    fi
    NGINX_USER="nginx"
fi

# 2. è‡ªåŠ¨å¯»æ‰¾ ZIP åŒ…
ZIP_FILE=$(find /root -maxdepth 1 -name "*.zip" | head -n 1)

if [ -z "$ZIP_FILE" ]; then
    echo "âŒ é”™è¯¯ï¼šåœ¨ /root ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ° .zip è¯ä¹¦åŒ…ï¼"
    echo "ğŸ‘‰ è¯·å…ˆä¸Šä¼ è…¾è®¯äº‘/é˜¿é‡Œäº‘ä¸‹è½½çš„ Nginx è¯ä¹¦åŒ…åˆ° /root ç›®å½•ã€‚"
    exit 1
fi

echo ">> å‘ç°è¯ä¹¦åŒ…: $ZIP_FILE"
echo ">> æ­£åœ¨è§£å‹..."

# å‡†å¤‡ä¸´æ—¶ç›®å½•
WORK_DIR="/tmp/ssl_install"
rm -rf $WORK_DIR
mkdir -p $WORK_DIR
unzip -q -o "$ZIP_FILE" -d $WORK_DIR

# 3. æ™ºèƒ½æŸ¥æ‰¾
KEY_FILE=$(find $WORK_DIR -name "*.key" | head -n 1)
CERT_FILE=$(find $WORK_DIR -name "*.pem" -o -name "*.crt" -o -name "*.bundle" | head -n 1)

if [ -z "$KEY_FILE" ] || [ -z "$CERT_FILE" ]; then
    echo "âŒ é”™è¯¯ï¼šè§£å‹åæœªæ‰¾åˆ° .key æˆ– .pem/.crt æ–‡ä»¶ã€‚"
    exit 1
fi

# 4. éƒ¨ç½²è¯ä¹¦
SSL_DIR="/etc/nginx/ssl"
mkdir -p $SSL_DIR
cp "$KEY_FILE" "$SSL_DIR/ranxiaoer.key"
cp "$CERT_FILE" "$SSL_DIR/ranxiaoer.pem"

# 5. è¯¢é—®åŸŸå
echo ""
read -p "è¯·è¾“å…¥ä½ çš„åŸŸå (ä¾‹å¦‚ ranxiaoer.com): " DOMAIN < /dev/tty
if [ -z "$DOMAIN" ]; then echo "åŸŸåä¸èƒ½ä¸ºç©º"; exit 1; fi

# 6. Nginx é…ç½®
echo ">> é…ç½® Nginx (HTTPS)..."
cat > /etc/nginx/nginx.conf <<NGINX
user $NGINX_USER;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;
include /usr/share/nginx/modules/*.conf;
events { worker_connections 1024; }
http {
    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" \$status \$body_bytes_sent';
    access_log /var/log/nginx/access.log main;
    sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048;
    include /etc/nginx/mime.types; default_type application/octet-stream;

    server {
        listen 80;
        server_name $DOMAIN;
        return 301 https://\$host\$request_uri;
    }

    server {
        listen 443 ssl;
        server_name $DOMAIN;
        ssl_certificate /etc/nginx/ssl/ranxiaoer.pem;
        ssl_certificate_key /etc/nginx/ssl/ranxiaoer.key;
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 10m;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
    }
}
NGINX

# 7. é‡å¯
systemctl restart ranxiaoer
systemctl restart nginx
rm -rf $WORK_DIR

echo "âœ… è¯ä¹¦å®‰è£…æˆåŠŸï¼è¯·è®¿é—® https://$DOMAIN"
